classdef usbl4
    %UNTITLED Summary of this class goes here
    %   Detailed explanation goes here
    
    properties (SetAccess = 'immutable')
        params
        h1
        h2
        h3
        h4
        H
    end
    
    methods
        function obj = usbl4(positions, params)
            assert(all(size(positions) == [4,3]), "positions must be 4x3");
            obj.h1 = positions(1,:);
            obj.h2 = positions(2,:);
            obj.h3 = positions(3,:);
            obj.h4 = positions(4,:);
            
            obj.H = [obj.h2-obj.h1;
                     obj.h3-obj.h1;
                     obj.h4-obj.h1];
                 
            assert(abs(det(obj.H)) > 1e-5, "hydrophones must be non-coplanar!");
            assert(isfield(params, 'sampleRate'), 'sampleRate field [samples/second] missing!');
            assert(isfield(params, 'speedOfSound'), 'speedOfSound field [meters/second] missing!');
            assert(isfield(params, 'blockLen'), 'blockLen field [samples] missing!');
            obj.params = params;
        end
        
        function bearing = bearing(usbl4, toas)
            % Assumes times of arrival are relative to hydrophone h0
            assert(all(size(toas) == [3,1]), "TOAs must be a 3x1 col vector")
            
            d = toas * usbl4.params.speedOfSound;
            bearing = usbl4.H\d; % inv(usbl4.H) * d
            bearing = bearing/norm(bearing);
        end
        
        function toas = toas(usbl4, signals)
            tic
            toas = zeros(3,1);
            assert(all(size(signals) == [4,usbl4.params.blockLen]), "signals must be 4xblockLen");
            oldPts = linspace(0,usbl4.params.blockLen, usbl4.params.blockLen);
            interpFactor = 10;
            newPts = linspace(0,usbl4.params.blockLen, usbl4.params.blockLen * interpFactor);
            
            s1 = interp1(oldPts, signals(1,:), newPts, 'spline');
            s2 = interp1(oldPts, signals(2,:), newPts, 'spline');
            s3 = interp1(oldPts, signals(3,:), newPts, 'spline');
            s4 = interp1(oldPts, signals(4,:), newPts, 'spline');
            
            threshold = 0.5;
            preCrop = 400*1e-6*usbl4.params.sampleRate;
            postCrop = 800*1e-6*usbl4.params.sampleRate;
            
            p1 = find(s1 > threshold,1);
            p2 = find(s2 > threshold,1);
            p3 = find(s3 > threshold,1);
            p4 = find(s4 > threshold,1);
            
            s1(1:p1-preCrop) = 0;
            s2(1:p2-preCrop) = 0;
            s3(1:p3-preCrop) = 0;
            s4(1:p4-preCrop) = 0;
            
            s1(p1+postCrop:end) = 0;
            s2(p2+postCrop:end) = 0;
            s3(p3+postCrop:end) = 0;
            s4(p4+postCrop:end) = 0;
            
            [~, corr1] = max(xcorr(s2,s1));
            [~, corr2] = max(xcorr(s3,s1));
            [~, corr3] = max(xcorr(s4,s1));
            
            toas(1) = (size(s1,2) - corr1)/(usbl4.params.sampleRate*interpFactor);
            toas(2) = (size(s1,2) - corr2)/(usbl4.params.sampleRate*interpFactor);
            toas(3) = (size(s1,2) - corr3)/(usbl4.params.sampleRate*interpFactor);
        end
    end
end

